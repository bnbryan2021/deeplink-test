<script>
  // 這支影片（單頁版）
  const VID = "73iL02p9iPo";

  // Web 版備援
  const WEB = `https://www.youtube.com/watch?v=${VID}&feature=youtu.be`;

  // iOS 可能支援的多種 scheme（不同版本/瀏覽器會吃不同寫法）
  const IOS_SCHEMES = [
    `youtube://www.youtube.com/watch?v=${VID}`,
    `youtube://watch?v=${VID}`,
    `vnd.youtube://www.youtube.com/watch?v=${VID}`,
    `vnd.youtube://watch/${VID}`
  ];

  // Android 用 intent（成功率最高，且自帶 fallback_url）
  const ANDROID_INTENT =
    `intent://www.youtube.com/watch?v=${VID}` +
    `#Intent;scheme=https;package=com.google.android.youtube;` +
    `S.browser_fallback_url=${encodeURIComponent(WEB)};end`;

  // UA 判斷
  const ua = navigator.userAgent.toLowerCase();
  const inApp = /fbav|instagram|line|messenger/.test(ua);
  const isAndroid = /android/.test(ua);
  const isIOS = /iphone|ipad|ipod/.test(ua);

  // 成功開 App 時，頁面會變不可見；用這點避免誤觸發 fallback
  let opened = false;
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) opened = true;
  });

  function openApp() {
    if (inApp) {
      // 內建瀏覽器無法直開 App：直接開網頁版
      location.href = WEB;
      return;
    }

    if (isAndroid) {
      // Android：直接丟 intent
      location.href = ANDROID_INTENT;
      return;
    }

    if (isIOS) {
      // iOS：依序嘗試多種 scheme，並設置保險 fallback
      let i = 0;

      const tryNext = () => {
        if (opened || i >= IOS_SCHEMES.length) return;
        location.href = IOS_SCHEMES[i++];
        // 每 700ms 嘗試下一種寫法，最多嘗試 4 種
        setTimeout(() => { if (!opened) tryNext(); }, 700);
      };

      // 最終備援：1.8s 後還沒成功就回網頁版
      setTimeout(() => {
        if (!opened) location.href = WEB;
      }, 1800);

      tryNext();
      return;
    }

    // 其他平台：直接開網頁版
    location.href = WEB;
  }

  // 載入就嘗試一次；同時綁定按鈕重試（需要的話）
  window.addEventListener('load', () => {
    // 某些瀏覽器會限制非使用者手勢自動開啟，保留自動嘗試 + 手動按鈕
    openApp();
    const btn = document.getElementById('open') || document.getElementById('openApp');
    if (btn) btn.addEventListener('click', (e) => { e.preventDefault(); openApp(); });
  });
</script>
